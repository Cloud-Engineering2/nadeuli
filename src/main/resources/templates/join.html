<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì¼ì • ì´ˆëŒ€ì¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/join-invitation.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/header-footer.css}">
</head>
<body>
<div class="naduli-layout">
    <div class="main-text-wrap">
        <div class="main-text">
            <div class="text-line"><span class="highlight">ë‚˜</span>ë“¤ì´ ê°€ëŠ” ë‚  ì„¤ë ˆëŠ” ë§ˆìŒìœ¼ë¡œ ì§ì„ ì±™ê¸°ê³ ,</div>
            <div class="text-line"><span class="highlight">ë“¤</span>íŒì„ ê±·ê³  ë§‘ì€ ê³µê¸°ë¥¼ ë§ˆì‹œë©° ê²½í—˜í•œ</div>
            <div class="text-line"><span class="highlight">ì´</span> ëˆˆë¶€ì‹  ìˆœê°„ì„ ê¸°ë¡í•´ìš”!</div>
        </div>
    </div>
    <div class="invitation-card">
        <a href="/">
            <div class="invite-logo-wrap">
                <img src="/images/pic-icon/logo-letter-x.png" alt="ë‚˜ë“¤ì´" width="50px" height="50px">
                <h1>ë‚˜ë“¤ì´</h1>
            </div>
        </a>
        <div class="invite-content">
            <h2 class="invite-content-title" th:text="${itinerary.itinerary.itineraryName}">ì¼ì • ì œëª©</h2>

            <p class="invite-content-start-date"><strong>ì—¬í–‰ ì‹œì‘ì¼:</strong>
                <span th:text="${#temporals.format(itinerary.itinerary.startDate, 'yyyyë…„ MMì›” ddì¼')}">2025ë…„ 03ì›” 20ì¼</span>
            </p>
            <p class="invite-content-totalDays"><strong>ì´ ì—¬í–‰ì¼ìˆ˜:</strong>
                <span th:text="${itinerary.itinerary.totalDays}">3</span>ì¼
            </p>
            <p class="invite-content-owner"><strong>ì¼ì • ìƒì„±ì:</strong>
                <span th:text="${itinerary.ownerName}">í™ê¸¸ë™</span>
            </p>
        </div>
        <div class="invite-bottom">
            <div id="join-message-area" class="mt-3"></div>
            <div class="btn-wrap">
                <button id="join-btn" class="btn btn-outline-secondary px-4 py-2 mt-2">ì¼ì • ì°¸ì—¬í•˜ê¸°</button>
                <div id="view-itinerary-btn-area"></div>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footerFragment}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        const $joinBtn = $('#join-btn');
        const $messageArea = $('#join-message-area');

        // í˜„ì¬ URLì—ì„œ ë§ˆì§€ë§‰ path ë¶€ë¶„ì„ shareToken ìœ¼ë¡œ ì¶”ì¶œ (/share/invite/abc123 êµ¬ì¡°ë¼ê³  ê°€ì •)
        const pathParts = window.location.pathname.split('/');
        const shareToken = pathParts[pathParts.length - 1];  // abc123

        $joinBtn.on('click', function () {
            if ($joinBtn.prop('disabled')) return;

            $joinBtn.prop('disabled', true).text('ì°¸ì—¬ ìš”ì²­ ì¤‘...');

            $.ajax({
                url: '/api/share/join',
                method: 'POST',
                data: { shareToken: shareToken },
                    success: function (res) {
                        showMessage('success', res.message);
                        $joinBtn.text('ì°¸ì—¬ ì™„ë£Œ');

                        // ğŸ‘‰ ì¼ì • ë³´ê¸° ë²„íŠ¼ ìƒì„±
                        if (res.itineraryId) {
                            const viewUrl = '/itinerary/view/' + res.itineraryId;
                            $('#view-itinerary-btn-area').html(`
                                <a href="${viewUrl}" class="btn btn-primary px-4 py-2 mt-2">ì¼ì • ë³´ê¸°</a>
                            `);
                        }
                    },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        const currentUrl = window.location.href;
                        window.location.href = '/login?redirect=' + encodeURIComponent(currentUrl);
                    } else {
                        const message = xhr.responseJSON?.message || 'ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        showMessage('danger', message);
                        $joinBtn.prop('disabled', false).text('ì¼ì • ì°¸ì—¬í•˜ê¸°');

                        // âœ… ë²„íŠ¼ ì˜ì—­ ì²˜ë¦¬
                        const $btnArea = $('#view-itinerary-btn-area');
                        $btnArea.empty();

                        if (message === 'ì´ë¯¸ ì¼ì •ì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤.') {
                            $btnArea.html(`
                                <a href="/itinerary/mylist" class="btn btn-outline-primary px-4 py-2 mt-2">ë‚´ ì¼ì • ë³´ê¸°</a>
                            `);
                        }
                    }
                }
            });
        });

        function showMessage(type, message) {
            $messageArea.html(
                `<div class="alert alert-${type}" role="alert">${message}</div>`
            );
        }
    });
</script>



</body>
</html>

