<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ì • ë“œë˜ê·¸ ì•¤ ë“œë¡­</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #F3F3F3; /* ê¸°ì¡´ ë°°ê²½ìƒ‰ì„ ë¶€ë“œëŸ¬ìš´ White ê³„ì—´ë¡œ ë³€ê²½ */
        }
        body {
            overflow-x: hidden;
        }
        .container-fluid {
            display: flex;
            height: calc(100vh - 60px); /* í—¤ë” ë†’ì´ ì œì™¸ */
            padding : 0px;
            margin-top: 60px;
        }
        /* ì™¼ìª½ íŒ¨ë„ */
        #sidebar {
            background: #e7e7e7; /* ê¸°ì¡´ ë°°ê²½ì„ Beige ê³„ì—´ë¡œ ë³€ê²½ */
            color: #343434; /* í…ìŠ¤íŠ¸ë¥¼ Black ê³„ì—´ë¡œ ë³€ê²½í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ */
            padding: 20px;
            min-width: 300px;
            max-width: 2000px;
            width: 1000px; /* ê¸°ë³¸ ë„ˆë¹„ */
            overflow: auto;
        }
        /* í¬ê¸° ì¡°ì ˆ í•¸ë“¤ */
        #resize-handle {
            width: 10px;
            cursor: ew-resize;

            background: #8E8B82; /* ê·¸ë ˆì´í†¤ ì ìš©í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ìš´ ëŠë‚Œ ì¶”ê°€ */
            height: 100%;
            position: absolute;  /* ìƒëŒ€ ìœ„ì¹˜ì—ì„œ ë²—ì–´ë‚˜ ììœ ë¡­ê²Œ ì´ë™ */
            left: 1000px;  /* ì´ˆê¸°ê°’: ì‚¬ì´ë“œë°” ê¸°ë³¸ í¬ê¸° */
            top: 0;
            z-index: 10;
        }
        /* ì˜¤ë¥¸ìª½ ì»¨í…ì¸  */
        #content {
            flex-grow: 1;
            background: #F3F3F3; /* ì „ì²´ì ì¸ ë°°ê²½ê³¼ ì¡°í™”ë¥¼ ì´ë£¨ë„ë¡ White ì ìš© */
        }
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        #header {
            background: #343434; /* ê¸°ì¡´ì˜ ë¸”ë£¨ ê³„ì—´ì„ ì°¨ë¶„í•œ Black ê³„ì—´ë¡œ ë³€ê²½ */
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            position: fixed;
            top: 0;
            width: 100%;
            height: 60px;
            z-index: 1000;
        }


        /* ğŸš€ ì¼ì • ê³„íší‘œ ê°€ë¡œ ë°°ì¹˜ */
        .schedule-container {
            display: flex;
            flex-direction: row; /* âœ… ê°€ë¡œ ì •ë ¬ */
            margin-right: 50px;
            gap: 5px;
            /*overflow-x: auto; !* âœ… ê°€ë¡œ ìŠ¤í¬ë¡¤ ì§€ì› *!*/
            /*min-width: 800px; !* âœ… ìµœì†Œ ê°€ë¡œ ê¸¸ì´ ìœ ì§€ *!*/
        }

        .savedPlace {
            width: 200px !important;
            min-width: 200px  !important;/* âœ… ê° ì¼ì • ì¹¼ëŸ¼ ìµœì†Œ ê°€ë¡œ ê¸¸ì´ ìœ ì§€ */
        }

        .savedPlace .event-order{
            display: none !important;
        }
        .savedPlace .travel-info{
            display: none !important;
        }
        .day-column {
            /* border: 1px #896b2782 solid; */
            border-radius: 2px;
            width: 280px;
            min-width: 280px; /* âœ… ê° ì¼ì • ì¹¼ëŸ¼ ìµœì†Œ ê°€ë¡œ ê¸¸ì´ ìœ ì§€ */
        }
        .day-header {
            background-color: #343434;
            font-weight: bold;
            /*text-align: center;*/
            /*margin-bottom: 10px;*/
            color: #dbd8d1;
            /* Grey ì ìš©í•˜ì—¬ ê°•ì¡° */
            padding: 8px;
            border-bottom: 1px #e3e3e3 solid;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between; /* ì¢Œìš° ì •ë ¬ */
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            padding: 10px;
            background: linear-gradient(88deg, #d5d3cf, #ffffff00); /* Whiteì™€ Beige ê·¸ë¼ë””ì–¸íŠ¸ ì ìš© */
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            width: 100%;
            position: sticky;
            margin-bottom: 10px;
            top: 0;
            z-index: 10;
        }


        .schedule-header-name {
            margin-left: 10px;
            font-size: 1.5rem; /* í¬ê³  ê°•ì¡°ëœ í…ìŠ¤íŠ¸ */
            font-weight: bold;
            color: #343434;
            text-transform: uppercase; /* ëŒ€ë¬¸ìë¡œ ë³€í™˜ */
            letter-spacing: 1px; /* ê¸€ì ê°„ê²© */
        }

        .schedule-header-date {
            margin-left: 10px;
            font-size: 1rem;
            color: #6c757d; /* íšŒìƒ‰í†¤ìœ¼ë¡œ ë³´ì¡° ì •ë³´ ëŠë‚Œ */
            font-weight: 500;
        }


        .schedule-header-right {
            margin-left: auto; /* ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ì´ë™ */
        }

        .event-options-button.schedule {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .event-options-button.schedule:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .event-container {
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
            background: #f9f9f9;
            min-height: 70px;
            padding: 10px;
        }



        .event {
            display: flex;
            width: 100%;
        }

        .event-wrapper {
            display: flex;
            width: 100%;
            flex-direction: column;
            align-items: flex-start; /* ì¢Œì¸¡ ì •ë ¬ */
        }

        .travel-info {
            margin-bottom: 8px; /* ì´ë™ ì‹œê°„ê³¼ ì´ë²¤íŠ¸ ë‚´ìš© ì‚¬ì´ ê°„ê²© */
        }

        .event-content {
            display: flex;
            width: 100%;
            align-items: center;
            justify-content: center;
            background-color: transparent; /* ë°°ê²½ìƒ‰ ì¶”ê°€ */

            text-align: left;
        }

        .event-order {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 40px; /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ í¬ê¸° */
            height: 70px; /* ì„ ê³¼ ì›ì„ í¬í•¨í•œ ë†’ì´ */
        }



        .event-order-line {
            width: 1px;

            background-color: #8E8B82; /* Grey ì ìš©í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ì›€ ì¶”ê°€ */

            z-index: 0; /* ì„ ì„ ì›ì˜ ë’¤ë¡œ ë°°ì¹˜ */
        }



        .event-order-line.top {
            height: 30%;
        }


        .event-order-line.bottom {
            height: 90%;
        }

        .event .event-order-line.transparent {
            background-color: transparent !important;
        }


        .event-order-circle {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid gray;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            position: absolute;
            top: 30%;
            transform: translateY(-50%);
            z-index: 1; /* ì›ì´ ì„  ìœ„ë¡œ ì˜¤ë„ë¡ ì„¤ì • */
        }
        .event-main {
            display: flex;
            width: 100%;
            padding-top: 4px;
            padding-left: 4px;
            padding-bottom: 4px;
            color: #514f49;
            border-radius: 4px;
            background: #ffffff87;
            border: 1px solid rgb(0 0 0 / 34%);
            box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
            text-align: left;
            cursor: grab;
            margin-bottom: 8px;
            min-height: 50px;
        }

        .event-left {
            padding-left: 5px;
            flex: 9; /* ì™¼ìª½ ë°•ìŠ¤ë¥¼ 9ë°° í¬ê¸°ë¡œ ì„¤ì • */
        }

        .event-right {
            flex: 1; /* ì˜¤ë¥¸ìª½ ë°•ìŠ¤ë¥¼ 1ë°° í¬ê¸°ë¡œ ì„¤ì • */
            display: flex;
            position: relative;
            justify-content: center; /* ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
            align-items: center;
        }



        .event-options-button {
            color: black;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }

        .event-options {
            position: absolute;
            top: 80%;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            min-width: 120px;
            z-index: 10;
        }

        .event-options button {
            background: none;
            border: none;
            padding: 8px;
            text-align: left;
            cursor: pointer;
            width: 100%;
        }

        .event-options button:hover {
            background: #f0f0f0;
        }

        /* ë©”ë‰´ ê¸°ë³¸ ìˆ¨ê¹€ */
        .hidden {
            display: none;
        }


        .sortable-ghost .tour-image {
            display: none !important;
        }

        .sortable-drag .event-order{
            visibility: hidden !important;

        }
        .sortable-drag .travel-info{
            visibility: hidden !important;

        }


        .sortable-ghost {
            opacity: 0.5;
            background: transparent;
        }
        .sortable-drag {
            opacity: 0.8;
            transform: scale(1.05);
        }

        /* ğŸš€ ì´ë™ ì‹œê°„ ë ˆì´ë¸” ìŠ¤íƒ€ì¼ */
        .travel-time {
            text-align: center;
            font-size: 0.8rem;
            margin: 3px auto;
            padding: 5px;
            width: 100%;
            background: #E9DCBE; /* Beige ê³„ì—´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë°°ê²½ ì ìš© */
            color: #343434; /* ê°€ë…ì„± í–¥ìƒì„ ìœ„í•œ Black ê³„ì—´ ì ìš© */
            border-radius: 5px;
            pointer-events: none;
            user-select: none;
        }



    </style>
</head>
<body>
<!-- ìƒë‹¨ í—¤ë” -->
<div id="header">
    ë‚˜ë“¤ì´
    <button id="save-button">ì €ì¥í•˜ê¸°</button>
</div>

<div class="container-fluid">

        <!-- ì™¼ìª½ íŒ¨ë„ -->
        <div id="sidebar" class="col-md-3">
            <div class="schedule-header" id="scheduleHeader">
                <div class="schedule-header-left">
                    <div class="schedule-header-name">ì—¬í–‰ ì œëª©</div>
                    <div class="schedule-header-date">2025/03/02(í™”) ~ 2025/03/08(ëª©)</div>
                </div>
                <div class="schedule-header-right">
                    <button class="event-options-button schedule">âš™ï¸</button>
                    <div class="event-options hidden">
                        <button class="event-duration">ì„¸ë¶€ ì„¤ì •</button>
                        <button class="event-remove">ì¼ì •í‘œ ì‚­ì œ</button>
                    </div>ï¸
                </div>
            </div>

            <div class="schedule-container" id="scheduleContainer"></div>
        </div>

        <!-- í¬ê¸° ì¡°ì ˆ í•¸ë“¤ -->
        <div id="resize-handle"></div>

        <!-- ì˜¤ë¥¸ìª½ ì§€ë„ -->
        <div class="col-md-9">
            <div id="map" style="height: 100%; background: lightblue;">ì§€ë„ ì˜ì—­</div>
        </div>

</div>

<script>
    let itinerary = null;
    const perDayMap = new Map();
    const eventMap = new Map();
    const groupedByDay = {}; // ë Œë”ë§ìš© - perDay ë³„ë¡œ ì •ë ¬ëœ event ë¦¬ìŠ¤íŠ¸

    $(document).ready(function () {
        $("#save-button").click(function () {
            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° "ì €ì¥ì¤‘..." í‘œì‹œ
            const $button = $(this);
            $button.prop("disabled", true).text("ì €ì¥ì¤‘...");

            // JSON ë°ì´í„° ìƒì„±
            const jsonData = generateItineraryJson();

            // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
            $.ajax({
                url: "http://localhost:8085/api/itinerary/update",
                method: "POST",
                contentType: "application/json",
                data: jsonData,
                success: function (response) {
                    console.log("ì €ì¥ ì„±ê³µ:", response);
                    alert("ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                },
                error: function (xhr, status, error) {
                    console.error("ì €ì¥ ì‹¤íŒ¨:", error);
                    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                },
                complete: function () {
                    // ë²„íŠ¼ í™œì„±í™” ë° ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë³µì›
                    $button.prop("disabled", false).text("ì €ì¥í•˜ê¸°");
                }
            });
        });
    });

    // JSON ë°ì´í„° ìƒì„± í•¨ìˆ˜
    function generateItineraryJson() {
        // ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±°
        const { createdDate, modifiedDate, role, ...filteredItinerary } = itinerary;

        // perDayMapì„ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë³€í™˜
        const itineraryPerDays = Array.from(perDayMap.values());

        // eventMap ë³€í™˜ (placeDTO.idë¥¼ pidë¡œ, stayMinute ì œê±°)
        const itineraryEvents = Array.from(eventMap.values()).map(event => ({
            ...event,
            pid: event.placeDTO.id, // placeDTO.idë¥¼ pidë¡œ ë³€ê²½
            placeDTO: undefined, // placeDTO ì œê±°
            stayMinute: undefined // stayMinute ì œê±°
        }));

        return JSON.stringify({ itinerary: filteredItinerary, itineraryPerDays, itineraryEvents });
    }


    function generateHashCode(length = 10) {
        const array = new Uint8Array(length);
        window.crypto.getRandomValues(array);
        return btoa(String.fromCharCode(...array)).replace(/[^a-zA-Z0-9]/g, '').substring(0, length);
    }

    function generateUniqueId(map, length = 10) {
        let id;
        do {
            id = generateHashCode(length);
        } while (map.has(id)); // ì¤‘ë³µëœ IDê°€ ì¡´ì¬í•˜ë©´ ë‹¤ì‹œ ìƒì„±
        return id;
    }

    function addEvent(event) {
        const id = generateUniqueId(eventMap);
        eventMap.set(id, event);
        return id; // ìƒì„±ëœ ID ë°˜í™˜
    }

    function getEventById(id) {
        return eventMap.get(id) || null; // ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ null ë°˜í™˜
    }

    // event ë©”ë‰´ ì—´ê¸°
    $(document).on("click", ".event-options-button", function (event) {
        event.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
        let menu = $(this).siblings(".event-options");

        // ë‹¤ë¥¸ ì—´ë¦° ë©”ë‰´ ë‹«ê¸°
        $(".event-options").not(menu).addClass("hidden");

        // í˜„ì¬ ë©”ë‰´ í† ê¸€
        menu.toggleClass("hidden");
    });

    // ë‹¤ë¥¸ ê³³ì„ í´ë¦­í•˜ë©´ ë©”ë‰´ ë‹«ê¸°
    $(document).on("click", function () {
        $(".event-options").addClass("hidden");
    });

    // ë©”ë‰´ ë‚´ë¶€ í´ë¦­ ì‹œ ë‹«íˆì§€ ì•Šë„ë¡ ì²˜ë¦¬
    $(document).on("click", ".event-options", function (event) {
        event.stopPropagation();
    });

    $(document).ready(function () {
        // í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥
        $("#resize-handle").mousedown(function (e) {
            e.preventDefault();

            $(document).mousemove(function (e) {
                let newWidth = e.pageX;

                // ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œí•œ
                if (newWidth >= 300 && newWidth <= 2000) {
                    $("#sidebar").css("width", newWidth + "px");
                    $("#resize-handle").css("left", newWidth + "px"); // í•¸ë“¤ì„ ì‚¬ì´ë“œë°” ëì— ìœ„ì¹˜
                }
            });

            $(document).mouseup(function () {
                $(document).off("mousemove");
            });
        });
    });

    $(document).ready(function () {
        const data = {
            "itinerary": {
                "id": 1,
                "itineraryName": "Tokyo Exploration",
                "startDate": "2025-06-01T00:00:00",
                "totalDays": 3,
                "transportationType": 1,
                "createdDate": "2025-02-28T14:36:41",
                "modifiedDate": "2025-02-28T14:36:41",
                "role": "ROLE_OWNER"
            },
            "itineraryPerDays": [{
                "dayCount": 0,
                "startTime": "00:00:00",
                "endTime": "00:00:00",
                "dayOfWeek": 0
            }, {"id": 1, "dayCount": 1, "startTime": "08:00:00", "endTime": "22:00:00", "dayOfWeek": 1}, {
                "id": 2,
                "dayCount": 2,
                "startTime": "09:00:00",
                "endTime": "21:30:00",
                "dayOfWeek": 2
            }, {"id": 3, "dayCount": 3, "startTime": "07:30:00", "endTime": "23:00:00", "dayOfWeek": 3}],
            "itineraryEvents": [{
                "id": 1,
                "dayCount": 1,
                "placeDTO": {
                    "id": 1,
                    "googlePlaceId": "tokyo1",
                    "placeName": "Shibuya Crossing",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 420,
                "endMinuteSinceStartDay": 540,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 2,
                "dayCount": 1,
                "placeDTO": {
                    "id": 2,
                    "googlePlaceId": "tokyo2",
                    "placeName": "Tokyo Tower",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 0,
                "endMinuteSinceStartDay": 90,
                "movingMinuteFromPrevPlace": 0
            }, {
                "id": 3,
                "dayCount": 1,
                "placeDTO": {
                    "id": 3,
                    "googlePlaceId": "tokyo3",
                    "placeName": "Shinjuku Gyoen",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 270,
                "endMinuteSinceStartDay": 390,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 4,
                "dayCount": 1,
                "placeDTO": {
                    "id": 4,
                    "googlePlaceId": "tokyo4",
                    "placeName": "Akihabara",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 120,
                "endMinuteSinceStartDay": 240,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 5,
                "dayCount": 1,
                "placeDTO": {
                    "id": 5,
                    "googlePlaceId": "tokyo5",
                    "placeName": "Asakusa Temple",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 570,
                "endMinuteSinceStartDay": 690,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 6,
                "dayCount": 2,
                "placeDTO": {
                    "id": 6,
                    "googlePlaceId": "tokyo6",
                    "placeName": "Odaiba",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 420,
                "endMinuteSinceStartDay": 540,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 7,
                "dayCount": 2,
                "placeDTO": {
                    "id": 7,
                    "googlePlaceId": "tokyo7",
                    "placeName": "Ginza Shopping District",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 0,
                "endMinuteSinceStartDay": 90,
                "movingMinuteFromPrevPlace": 0
            }, {
                "id": 8,
                "dayCount": 2,
                "placeDTO": {
                    "id": 8,
                    "googlePlaceId": "tokyo8",
                    "placeName": "Harajuku",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 270,
                "endMinuteSinceStartDay": 390,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 9,
                "dayCount": 2,
                "placeDTO": {
                    "id": 9,
                    "googlePlaceId": "tokyo9",
                    "placeName": "Ueno Park",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 120,
                "endMinuteSinceStartDay": 240,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 10,
                "dayCount": 3,
                "placeDTO": {
                    "id": 10,
                    "googlePlaceId": "tokyo10",
                    "placeName": "Tsukiji Market",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 0,
                "endMinuteSinceStartDay": 120,
                "movingMinuteFromPrevPlace": 0
            }, {
                "id": 11,
                "dayCount": 3,
                "placeDTO": {
                    "id": 11,
                    "googlePlaceId": "tokyo11",
                    "placeName": "Tokyo Disneyland",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 150,
                "endMinuteSinceStartDay": 360,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 12,
                "dayCount": 3,
                "placeDTO": {
                    "id": 12,
                    "googlePlaceId": "tokyo12",
                    "placeName": "Meiji Shrine",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 690,
                "endMinuteSinceStartDay": 810,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 13,
                "dayCount": 3,
                "placeDTO": {
                    "id": 13,
                    "googlePlaceId": "tokyo13",
                    "placeName": "Rainbow Bridge",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 390,
                "endMinuteSinceStartDay": 510,
                "movingMinuteFromPrevPlace": 30
            }, {
                "id": 14,
                "dayCount": 3,
                "placeDTO": {
                    "id": 14,
                    "googlePlaceId": "tokyo14",
                    "placeName": "Roppongi Hills",
                    "createdAt": "2025-02-28T14:36:52",
                    "modifiedAt": "2025-02-28T14:36:52"
                },
                "startMinuteSinceStartDay": 540,
                "endMinuteSinceStartDay": 660,
                "movingMinuteFromPrevPlace": 30
            }]
        };
        //const data = {"itinerary":{"id":21,"itineraryName":"ì„œìš¸ ì—¬í–‰","startDate":"2025-03-14T00:00:00","totalDays":4,"transportationType":1,"createdDate":"2025-03-04T03:09:29","modifiedDate":"2025-03-04T03:09:29","role":"ROLE_OWNER"},"itineraryPerDays":[{"id":91,"dayCount":0,"startTime":"00:00:00","endTime":"00:00:00","dayOfWeek":0},{"id":92,"dayCount":1,"startTime":"09:00:00","endTime":"23:00:00","dayOfWeek":5},{"id":93,"dayCount":2,"startTime":"09:00:00","endTime":"23:00:00","dayOfWeek":6},{"id":94,"dayCount":3,"startTime":"09:00:00","endTime":"23:00:00","dayOfWeek":7},{"id":95,"dayCount":4,"startTime":"09:00:00","endTime":"23:00:00","dayOfWeek":1}],"itineraryEvents":[]};
        createData(data);
        renderItinerary();
    });
        // $.ajax({
        //     url: "/api/itinerary/1",
        //     method: "GET",
        //     dataType: "json",
        //     success: function (data) {
        //         createData(data);
        //         renderItinerary();
        //     },
        //     error: function (xhr, status, error) {
        //         console.error("Error fetching itinerary:", error);
        //     }
        // });



        function createData(data){

            // itinerary ë³µì‚¬
            itinerary = { ... data.itinerary };

            // itineraryPerDays ë³µì‚¬
            perDayMap.clear();
            data.itineraryPerDays.forEach(dayPerDay => {
                perDayMap.set(dayPerDay.dayCount, {... dayPerDay});
                if (!groupedByDay[dayPerDay.dayCount]) {
                    groupedByDay[dayPerDay.dayCount] = [];
                }
            });


            // itineraryEvents ë³µì‚¬
            data.itineraryEvents.forEach(event => {
                const dayKey = event.dayCount;
                const baseStartTime = perDayMap.get(dayKey)?.startTime || "00:00:00"; // í•´ë‹¹ ë‚ ì§œì˜ ì‹œì‘ ì‹œê°„
                const baseStartMinutes = timeToMinutes(baseStartTime); // HH:MM:SS â†’ ë¶„ ë‹¨ìœ„ ë³€í™˜


                let editedEvent = {...event};
                editedEvent.stayMinute = editedEvent.endMinuteSinceStartDay - editedEvent.startMinuteSinceStartDay;

                let eventId = addEvent(editedEvent);

                groupedByDay[dayKey].push({
                    id: eventId,
                    placeName: event.placeDTO.placeName,
                    startMinute: baseStartMinutes + editedEvent.startMinuteSinceStartDay,
                    endMinute: baseStartMinutes + editedEvent.endMinuteSinceStartDay,
                    movingMinute: event.movingMinuteFromPrevPlace
                });
            });

            // ê° ì¼ì°¨ë³„ ì´ë²¤íŠ¸ ì •ë ¬ (ì‹œì‘ ì‹œê°„ ê¸°ì¤€)
            Object.keys(groupedByDay).forEach(dayKey => {
                groupedByDay[dayKey].sort((a, b) => a.startMinute - b.startMinute);
            });

        }


        function renderItinerary() {
            $(".schedule-header-name").text(itinerary.itineraryName);

            // ë‚ ì§œ ë³€í™˜ ë° í‘œì‹œ
            let startDate = new Date(itinerary.startDate);
            let endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + itinerary.totalDays - 1); // ë§ˆì§€ë§‰ ë‚ ì§œ ê³„ì‚°

            let options = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' };
            let startStr = startDate.toLocaleDateString('ko-KR', options);
            let endStr = endDate.toLocaleDateString('ko-KR', options);

            $(".schedule-header-date").text(`${startStr} ~ ${endStr}`);

            // ğŸš€ ì¼ì • UI ë Œë”ë§
            const scheduleContainer = $('#scheduleContainer');
            scheduleContainer.empty();
            console.log('START');
            Object.keys(groupedByDay).forEach(dayKey => {
                const dayNumber = parseInt(dayKey);
                console.log(dayNumber);
                const startTime = perDayMap.get(dayNumber)?.startTime || "00:00:00";
                let dayColumn = null

                if (dayNumber === 0) {
                    dayColumn = $(`
                                    <div class='day-column savedPlace'>
                                        <div class='day-header'>ì¥ì†Œë³´ê´€í•¨</div>
                                        <div class='event-container' id='day-${dayNumber}'></div>
                                    </div>
                                `);
                } else {

                    dayColumn = $(`
                                    <div class='day-column'>
                                        <div class='day-header'>${dayKey}ì¼ì°¨ (${startTime.substring(0,5)})</div>
                                        <div class='event-container' id='day-${dayNumber}'></div>
                                    </div>
                                `);

                }

                groupedByDay[dayKey].forEach((event, index) => {
                    const isFirst = index === 0;
                    const isLast = index === groupedByDay[dayKey].length - 1;

                    const eventElement = $(`
                                            <div class='event' data-id='${event.id}'>
                                                <div class="event-wrapper">
                                                    <div class="travel-info">ì´ë™ ì‹œê°„ ${event.movingMinute}ë¶„</div>
                                                    <div class="event-content">
                                                        <div class="event-order">
                                                            <div class="event-order-line top ${isFirst ? 'transparent' : ''}"></div>
                                                            <div class="event-order-circle">${index + 1}</div>
                                                            <div class="event-order-line bottom ${isLast ? 'transparent' : ''}"></div>
                                                        </div>
                                                        <div class="event-main">
                                                            <div class="event-left">
                                                                <div class='event-title'>${event.placeName}</div>
                                                                <div class='event-time'>${formatTime(event.startMinute)} ~ ${formatTime(event.endMinute)}</div>
                                                            </div>
                                                            <div class="event-right">
                                                                <button class="event-options-button">â‹®</button>
                                                                <div class="event-options hidden">
                                                                    <button class="event-duration">ë¨¸ë¬´ëŠ” ì‹œê°„</button>
                                                                    <button class="event-remove">ì‚­ì œ</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `);
                    if (dayKey === '0') {
                        eventElement.find('.event-time').detach();
                    }
                    dayColumn.find('.event-container').append(eventElement);
                });

                scheduleContainer.append(dayColumn);
            });

            // ğŸš€ ì´ˆê¸° ìƒíƒœì—ì„œ ê° ìš”ì¼ ì²« ë²ˆì§¸ .travel-info ìˆ¨ê¸°ê¸°
            $(".event-container").each(function () {
                $(this).find(".event .travel-info").first().css("display", "none");
            });

            initializeSortable(); // ğŸš€ ë“œë˜ê·¸ & ë“œë¡­ ê¸°ëŠ¥ í™œì„±í™”
        }

        // HH:MM:SS ë¬¸ìì—´ì„ ë¶„(minute)ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

         // ë¶„(minute) ê°’ì„ HH:MM í˜•íƒœë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }

        function moveDeletedPerDayEventsToSavedPlace(deletedPerDays) {
            console.log(`ğŸš€ ë‚ ì§œ ë³€ê²½ ê°ì§€: ì‚­ì œëœ perDay -> ì¥ì†Œë³´ê´€í•¨ ì´ë™`);

            // ì‚­ì œëœ perDayì˜ dayCount ë¦¬ìŠ¤íŠ¸
            const deletedDays = new Set(deletedPerDays.map(day => day.dayCount));

            // ì‚­ì œ ëŒ€ìƒ ì´ë²¤íŠ¸ë“¤ì„ ì°¾ê¸°
            const eventsToMove =  new Map();
            eventMap.forEach((event, eventId) => {
                if (deletedDays.has(event.dayCount)) {
                    event.dayCount = 0; // `day-0`ìœ¼ë¡œ ì´ë™
                    event.movingMinuteFromPrevPlace = 0; // ì¥ì†Œë³´ê´€í•¨ì€ ì´ë™ì‹œê°„ ì—†ìŒ
                    eventsToMove.set(eventId, event);
                }
            });
            console.log(eventsToMove);
            // UI ì—…ë°ì´íŠ¸ - ì¥ì†Œë³´ê´€í•¨ì— ì¶”ê°€
            if (eventsToMove.size > 0) {
                updateSavedPlaceUI(eventsToMove);
            }

            // ğŸš€ ì‚­ì œëœ perDayì˜ Column ì‚­ì œ & `perDayMap`ì—ì„œë„ ì œê±°
            deletedDays.forEach(dayCount => {
                let dayId = `day-${dayCount}`;
                let dayColumn = $(`#${dayId}`).closest(".day-column");

                if (dayColumn.length) {
                    console.log(`ğŸ—‘ï¸ ì¼ì • Column ì‚­ì œ: ${dayId}`);
                    dayColumn.remove();
                }

                // âœ… `perDayMap`ì—ì„œ ì‚­ì œ
                if (perDayMap.has(dayCount)) {
                    perDayMap.delete(dayCount);
                    console.log(`ğŸ—‘ï¸ perDayMapì—ì„œ ${dayCount} ì‚­ì œ`);
                }
            });

            console.log(`âœ… ${eventsToMove.size}ê°œ ì´ë²¤íŠ¸ ì¥ì†Œë³´ê´€í•¨ ì´ë™ ì™„ë£Œ, ì‚­ì œëœ day-column ë° perDayMap ì •ë¦¬ ì™„ë£Œ`);
        }



        function updateSavedPlaceUI(events) {
            const savedPlaceContainer = $("#day-0");
            if (!savedPlaceContainer.length) return;

            events.forEach((event, eventId)  => {
                const eventElement = $(`
            <div class='event' data-id='${eventId}'>
                <div class="event-wrapper">
                    <div class="travel-info"></div>
                    <div class="event-content">
                        <div class="event-order">
                            <div class="event-order-line top transparent"></div>
                            <div class="event-order-circle">X</div>
                            <div class="event-order-line bottom transparent"></div>
                        </div>
                        <div class="event-main">
                            <div class="event-left">
                                <div class='event-title'>${event.placeDTO.placeName}</div>
                            </div>
                            <div class="event-right">
                                <button class="event-options-button">â‹®</button>
                                <div class="event-options hidden">
                                    <button class="event-duration">ë¨¸ë¬´ëŠ” ì‹œê°„</button>
                                    <button class="event-remove">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `);

                savedPlaceContainer.append(eventElement);
            });

            console.log(`ğŸ—‚ ì¥ì†Œë³´ê´€í•¨(${events.length}ê°œ) ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
        }


        function initializeSortable() {
            $(".event-container").each(function() {
                createSortableInstance(this);
            });
        }

        // ìƒˆë¡œìš´ DayColumn ìƒì„±
        function createNewDayColumn(perDay) {
            const { dayCount, startTime = "09:00:00", endTime = "21:00:00" } = perDay;

            if (perDayMap.has(dayCount)) {
                console.warn(`âš ï¸ ${dayCount}ì¼ì°¨ëŠ” ì´ë¯¸ ì¡´ì¬í•¨!`);
                return;
            }

            console.log(`ğŸ“… ìƒˆë¡œìš´ day-column ìƒì„±: dayCount=${dayCount}, startTime=${startTime}, endTime=${endTime}`);

            // ğŸš€ `perDayMap`ì— ìƒˆë¡œìš´ `perDay` ì¶”ê°€
            perDayMap.set(dayCount, perDay);

            // ğŸš€ ìƒˆë¡œìš´ Column ìš”ì†Œ ìƒì„±
            let dayColumn = $(`
            <div class='day-column'>
                <div class='day-header'>${dayCount}ì¼ì°¨ (${startTime.substring(0, 5)})</div>
                <div class='event-container' id='day-${dayCount}'></div>
            </div>
        `);

        // ğŸš€ `schedule-container`ì— ì¶”ê°€
        $("#scheduleContainer").append(dayColumn);

        // ğŸš€ ìƒˆë¡œìš´ day-columnì— `Sortable` ì ìš©
        initializeSortableForColumn(`#day-${dayCount}`);

        console.log(`âœ… ${dayCount}ì¼ì°¨ Column ì¶”ê°€ ë° Sortable ë“±ë¡ ì™„ë£Œ`);
    }


    function initializeSortableForColumn(selector) {
        const element = document.querySelector(selector);
        if (!element) {
            console.warn(`âš ï¸ Sortable ì ìš© ì‹¤íŒ¨: ${selector} ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            return;
        }

        createSortableInstance(element);
    }



    function createSortableInstance(element) {
            return new Sortable(element, {
                group: "shared",
                animation: 200,
                ghostClass: "sortable-ghost",
                dragClass: "sortable-drag",
                handle: ".event-content",
                onStart: function(evt) {
                    $(".travel-info").css("visibility", "hidden");
                },
                onAdd: function(evt) {

                    let newItem = $(evt.item);
                    let eventId = newItem.data("id");
                    let event = getEventById(eventId);

                    newItem.replaceWith(`<div class='event' data-id='${eventId}'>
                                    <div class="event-wrapper">
                                        <div class="travel-info"></div>
                                        <div class="event-content">
                                            <div class="event-order">
                                                <div class="event-order-line top"></div>
                                                <div class="event-order-circle">1</div>
                                                <div class="event-order-line bottom"></div>
                                            </div>
                                            <div class="event-main">
                                                <div class="event-left">
                                                    <div class='event-title'>${event.placeDTO.placeName}</div>
                                                    <div class='event-time'></div>
                                                </div>
                                                <div class="event-right">
                                                    <button class="event-options-button">â‹®</button>
                                                    <div class="event-options hidden">
                                                        <button class="event-duration">ë¨¸ë¬´ëŠ” ì‹œê°„</button>
                                                        <button class="event-remove">ì‚­ì œ</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`);

                    console.log("ON ADD !");
                },
                onEnd: function (evt) {

                    let fromDayId = evt.from.id;
                    let oldIndex = evt.oldIndex;
                    let toDayId = evt.to.id;
                    let newIndex = evt.newIndex;

                    console.log(`[ì¶œë°œ] ${fromDayId}, oldIndex: ${oldIndex}`);
                    console.log(`[ë„ì°©] ${toDayId}, newIndex: ${newIndex}`);

                    let updateStartIndexFrom = null;
                    let updateStartIndexTo = null;

                    if (toDayId === fromDayId) {
                        console.log(`- ê°™ì€ ë¦¬ìŠ¤íŠ¸(${toDayId})ì—ì„œ ì´ë™`);
                        console.log(`-- ì˜í–¥ì„ ë°›ëŠ” ì¸ë±ìŠ¤`);
                        if (toDayId !== 'day-0') {
                            if (oldIndex !== newIndex) {
                                let movedForward = oldIndex > newIndex;
                                console.log(movedForward ? `--- ìš”ì†Œê°€ ê¸°ì¡´ë³´ë‹¤ ì•ìª½ìœ¼ë¡œ ì´ë™` : `--- ìš”ì†Œê°€ ê¸°ì¡´ë³´ë‹¤ ë’¤ìª½ìœ¼ë¡œ ì´ë™`);
                                updateStartIndexFrom = calculateDistanceUpdates(toDayId, oldIndex, newIndex, movedForward);

                            } else {
                                console.log(`--- ì´ë™í•˜ì§€ ì•ŠìŒ`);
                            }
                        }
                    } else {
                        if (toDayId === 'day-0'){
                            console.log(`- ì¥ì†Œë³´ê´€í•¨ìœ¼ë¡œ ì´ë™: ${fromDayId} â†’ ì¥ì†Œë³´ê´€í•¨`);
                            changeDayCount(toDayId, newIndex);
                            console.log(`-- [ì¶œë°œ ë¦¬ìŠ¤íŠ¸] ${fromDayId}ì—ì„œ ì œê±° í›„ ì˜í–¥`);
                            updateStartIndexFrom = calculateRemovalImpact(fromDayId, oldIndex);

                        } else if (fromDayId === 'day-0') {
                            console.log(`- ë‹¤ë¥¸ ë¦¬ìŠ¤íŠ¸ ì´ë™: ì¥ì†Œë³´ê´€í•¨ â†’ ${toDayId}`);
                            changeDayCount(toDayId, newIndex);
                            console.log(`-- [ë„ì°© ë¦¬ìŠ¤íŠ¸] ${toDayId}ì—ì„œ ì¶”ê°€ í›„ ì˜í–¥`);
                            updateStartIndexTo = calculateInsertionImpact(toDayId, newIndex);
                        } else {
                            console.log(`- ë‹¤ë¥¸ ë¦¬ìŠ¤íŠ¸ ì´ë™: ${fromDayId} â†’ ${toDayId}`);
                            changeDayCount(toDayId, newIndex);
                            console.log(`-- [ì¶œë°œ ë¦¬ìŠ¤íŠ¸] ${fromDayId}ì—ì„œ ì œê±° í›„ ì˜í–¥`);
                            updateStartIndexFrom = calculateRemovalImpact(fromDayId, oldIndex);
                            console.log(`-- [ë„ì°© ë¦¬ìŠ¤íŠ¸] ${toDayId}ì—ì„œ ì¶”ê°€ í›„ ì˜í–¥`);
                            updateStartIndexTo = calculateInsertionImpact(toDayId, newIndex);
                        }

                    }

                    if (updateStartIndexFrom !== null) {
                        updateEventDisplay(fromDayId, updateStartIndexFrom);
                    }
                    if (updateStartIndexTo !== null) {
                        updateEventDisplay(toDayId, updateStartIndexTo);
                    }

                    console.log(eventMap);
                    $(".travel-info").css("visibility", "visible");


                    if (toDayId !== 'day-0'){
                        $(evt.to).find(".event .travel-info").css("display", "block");
                        $(evt.to).find(".event .travel-info").first().css("display", "none");
                        $(evt.to).find(".event .event-order-line").removeClass("transparent");
                        $(evt.to).find(".event .event-order-line.top").first().addClass("transparent");
                        $(evt.to).find(".event .event-order-line.bottom").last().addClass("transparent");
                    }

                    if (fromDayId !== 'day-0') {
                        $(evt.from).find(".event .travel-info").css("display", "block");
                        $(evt.from).find(".event .travel-info").first().css("display", "none");
                        $(evt.from).find(".event .event-order-line").removeClass("transparent");
                        $(evt.from).find(".event .event-order-line.top").first().addClass("transparent");
                        $(evt.from).find(".event .event-order-line.bottom").last().addClass("transparent");
                    }


                    // console.log(evt);
                    // console.log(evt.to);
                    // console.log(evt.item);
                    // console.log(evt.from);
                    console.log("ON END !");
                }

            });
        }




    $(document).on("click", ".event-remove", function () {
            const eventElement = $(this).closest(".event");
            const eventId = eventElement.data("id");
            const eventContainer = eventElement.closest(".event-container");
            const dayId = eventContainer.attr("id");

            if (!eventId || !dayId) return;

            // ì‚­ì œí•  ì´ë²¤íŠ¸ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
            const items = eventContainer.children();
            const index = items.index(eventElement);

            console.log(`ğŸ—‘ï¸ ì‚­ì œ: dayId=${dayId}, eventId=${eventId}, index=${index}`);

            // ì‚­ì œ
            eventElement.remove();
            eventMap.delete(eventId);

            // ê±°ë¦¬(ì‹œê°„) ì¬ê³„ì‚°
            if (dayId !== "day-0") {
                const updateStartIndex = calculateRemovalImpact(dayId, index);
                updateEventDisplay(dayId, updateStartIndex);

                // âœ… ì‚­ì œ í›„ ì²« ë²ˆì§¸ `.travel-info` ìˆ¨ê¸°ê¸°
                $(eventContainer).find(".event .travel-info").css("display", "block");
                $(eventContainer).find(".event .travel-info").first().css("display", "none");

                // âœ… ì—°ê²°ì„  ì—…ë°ì´íŠ¸
                $(eventContainer).find(".event .event-order-line").removeClass("transparent");
                $(eventContainer).find(".event .event-order-line.top").first().addClass("transparent");
                $(eventContainer).find(".event .event-order-line.bottom").last().addClass("transparent");
            }
        });

        function changeDayCount(toDayId, newIndex) {
            const container = document.getElementById(toDayId);
            if (!container) return;
            const items = container.children;
            const eventElement = items[newIndex];
            const eventId = eventElement.getAttribute("data-id");
            const event = getEventById(eventId);
            event.dayCount = parseInt(toDayId.match(/\d+$/)[0]);
        }

        // âœ… ìˆœì„œ ë° ì´ë™ì‹œê°„ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateEventDisplay(dayId, startIndex) {
            const container = document.getElementById(dayId);
            if (!container) return;

            const dayCount = parseInt(dayId.match(/\d+$/)[0]); // day-ìˆ«ì â†’ ìˆ«ì ì¶”ì¶œ
            const items = container.children;
            let order = startIndex + 1; // ìƒˆë¡œìš´ ìˆœì„œê°’ ì„¤ì •

            // ì´ˆê¸° ì‹œê°„ì„ ê°€ì ¸ì˜´ (í•´ë‹¹ dayCountì˜ startTime)
            let baseStartTime = timeToMinutes(perDayMap.get(dayCount)?.startTime || "00:00:00");

            // ì´ì „ ì´ë²¤íŠ¸ì˜ ì¢…ë£Œ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (ì´ë™ì‹œê°„ ë°˜ì˜)
            let prevEndMinute = 0; // startIndexê°€ 0ì¼ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
            if (startIndex > 0) {
                const prevEventElement = items[startIndex - 1];
                const prevEventId = prevEventElement.getAttribute("data-id");
                const prevEvent = getEventById(prevEventId);

                if (prevEvent) {
                    prevEndMinute = prevEvent.startMinuteSinceStartDay + prevEvent.stayMinute;
                }
            }

            // âœ… ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸ ë£¨í”„
            for (let i = startIndex; i < items.length; i++) {
                const eventElement = items[i];
                const eventId = eventElement.getAttribute("data-id");
                const event = getEventById(eventId);

                if (!event) continue;

                // âœ… ìˆœì„œ ì—…ë°ì´íŠ¸ (event-order-circle)
                const orderCircle = eventElement.querySelector(".event-order-circle");
                if (orderCircle) {
                    orderCircle.textContent = order;
                }

                // âœ… ì´ë™ ì‹œê°„ ì—…ë°ì´íŠ¸ (travel-info)
                const travelInfo = eventElement.querySelector(".travel-info");
                if (travelInfo) {
                    travelInfo.textContent = `ì´ë™ ì‹œê°„ ${event.movingMinuteFromPrevPlace ?? 0}ë¶„`;
                }

                // âœ… ì´ë²¤íŠ¸ ì‹œê°„ ì—…ë°ì´íŠ¸ (event-time)
                const eventTimeElement = eventElement.querySelector(".event-time");
                if (eventTimeElement) {
                    let startMinute = prevEndMinute + (event.movingMinuteFromPrevPlace ?? 0); // ì´ë™ ì‹œê°„ ë°˜ì˜
                    let endMinute = startMinute + event.stayMinute; // ë¨¸ë¬´ëŠ” ì‹œê°„ ì¶”ê°€

                    // ì €ì¥ë˜ëŠ” ê°’ì€ baseStartTimeì„ ì œì™¸í•œ ìƒëŒ€ ê°’
                    event.startMinuteSinceStartDay = startMinute;
                    event.endMinuteSinceStartDay = endMinute;

                    // UIì— í‘œì‹œí•  ê°’ì€ baseStartTimeì„ ë”í•œ ì ˆëŒ€ ì‹œê°„
                    eventTimeElement.textContent = `${formatTime(startMinute + baseStartTime)} ~ ${formatTime(endMinute + baseStartTime)}`;

                    // ë‹¤ìŒ ì´ë²¤íŠ¸ì˜ ì‹œì‘ ì‹œê°„ ì—…ë°ì´íŠ¸
                    prevEndMinute = endMinute;
                }

                // âœ… ìµœì‹  ì´ë²¤íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                eventMap.set(eventId, event);

                order++; // ë‹¤ìŒ ìˆœì„œ ì¦ê°€
            }
        }

        function requestDistanceCalculation(placeId1, placeId2) {
            console.log(`ğŸš— ê±°ë¦¬(ì‹œê°„) ê³„ì‚° ìš”ì²­: ${placeId1} â†’ ${placeId2}`);

            // ëœë¤ ê°’ ìƒì„± (ì˜ˆì œ)
            const distance = Math.floor(Math.random() * 50) + 1; // 1 ~ 50km
            const minute = 30 ;//Math.floor(Math.random() * 120) + 1; // 1 ~ 120ë¶„

            return { distance, minute };
        }

        // íŠ¹ì • indexì˜ `data-id`ë¥¼ ê°€ì ¸ì™€ì„œ ì´ë²¤íŠ¸ ì¡°íšŒ ë° ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ í˜¸ì¶œ
        function calculateDistanceByIndex(dayId, index1, index2) {
            const container = document.getElementById(dayId);
            if (!container) return;

            const items = container.children;
            const itemCount = items.length;

            if (index1 < 0 || index2 < 0) {
                console.log(`âš ï¸ ê²½ê³ : index1=${index1}, index2=${index2} (index 0ì˜ ì´ë™ ì‹œê°„ì„ 0ìœ¼ë¡œ ì„¤ì •)`);

                // ì²« ë²ˆì§¸ ìš”ì†Œì˜ movingMinuteFromPrevPlaceë¥¼ 0ìœ¼ë¡œ ì„¤ì •
                const firstEventId = items[0]?.getAttribute("data-id");
                if (firstEventId) {
                    const firstEvent = getEventById(firstEventId);
                    if (firstEvent) {
                        firstEvent.movingMinuteFromPrevPlace = 0;
                        eventMap.set(firstEventId, firstEvent);
                        console.log(`âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${firstEventId}ì˜ movingMinuteFromPrevPlace â†’ 0ë¶„`);
                    }
                }
                return;
            }

            // ì˜ˆì™¸ ì²˜ë¦¬: ëë¶€ë¶„ (ë²”ìœ„ë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš°)
            if (index1 >= itemCount || index2 >= itemCount) {
                console.warn(`âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ë±ìŠ¤: index1=${index1}, index2=${index2}`);
                return;
            }

            const eventId1 = items[index1]?.getAttribute("data-id");
            const eventId2 = items[index2]?.getAttribute("data-id");

            if (!eventId1 || !eventId2) {
                console.warn(`âŒ ì´ë²¤íŠ¸ ID ì—†ìŒ: index1=${index1}, index2=${index2}`);
                return;
            }

            const event1 = getEventById(eventId1);
            const event2 = getEventById(eventId2);

            if (event1 && event2) {
                const { distance, minute } = requestDistanceCalculation(event1.placeDTO.googlePlaceId, event2.placeDTO.googlePlaceId);

                // event2ì˜ movingMinuteFromPrevPlace ì—…ë°ì´íŠ¸
                event2.movingMinuteFromPrevPlace = minute;

                // eventMap ì—…ë°ì´íŠ¸
                eventMap.set(eventId2, event2);

                console.log(`âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${eventId2}ì˜ movingMinuteFromPrevPlace â†’ ${minute}ë¶„`);
            } else {
                console.warn(`âŒ ì´ë²¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨: eventId1=${eventId1}, eventId2=${eventId2}`);
            }
        }


            // âœ… ê±°ë¦¬(ì‹œê°„) ê³„ì‚° ìš”ì²­ì„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
        function calculateDistanceUpdates(dayId, oldIndex, newIndex, movedForward) {
            console.log(`ğŸ”„ ê±°ë¦¬ ê³„ì‚° ì—…ë°ì´íŠ¸: ${dayId}, oldIndex: ${oldIndex} â†’ newIndex: ${newIndex}`);

            const calculatedPairs = new Set();

            function safeCalculateDistance(index1, index2) {
                const pairKey = `${index1}-${index2}`;
                if (!calculatedPairs.has(pairKey)) {
                    calculatedPairs.add(pairKey);
                    calculateDistanceByIndex(dayId, index1, index2);
                }
            }

            if (movedForward) {
                safeCalculateDistance(newIndex - 1, newIndex); // ìƒˆë¡œ ì‚½ì…ëœ ìœ„ì¹˜ì˜ ì•ìª½ ì˜í–¥
                safeCalculateDistance(newIndex, newIndex + 1); // ìƒˆë¡œ ì‚½ì…ëœ ìœ„ì¹˜ì˜ ë’¤ìª½ ì˜í–¥
                safeCalculateDistance(oldIndex, oldIndex + 1); // ì›ë˜ ìœ„ì¹˜ì˜ ë’¤ìª½ ì˜í–¥

            } else {
                safeCalculateDistance(newIndex - 1, newIndex); // ìƒˆë¡œ ì‚½ì…ëœ ìœ„ì¹˜ì˜ ì•ìª½ ì˜í–¥
                safeCalculateDistance(newIndex, newIndex + 1); // ìƒˆë¡œ ì‚½ì…ëœ ìœ„ì¹˜ì˜ ë’¤ìª½ ì˜í–¥
                safeCalculateDistance(oldIndex -1 , oldIndex); // ì›ë˜ ìœ„ì¹˜ì˜ ì•ìª½ ì˜í–¥
            }
            return movedForward ? newIndex : oldIndex; // updateEventDisplayì˜ ì‹œì‘ ì¸ë±ìŠ¤ë¥¼ ë°˜í™˜
        }

        // âœ… ì¶œë°œ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±° í›„ ê±°ë¦¬(ì‹œê°„) ê³„ì‚° í•¨ìˆ˜
        function calculateRemovalImpact(dayId, oldIndex) {
            calculateDistanceByIndex(dayId, oldIndex - 1, oldIndex);
            return oldIndex;
        }

        // âœ… ë„ì°© ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¶”ê°€ í›„ ê±°ë¦¬(ì‹œê°„) ê³„ì‚° í•¨ìˆ˜
        function calculateInsertionImpact(dayId, newIndex) {
            calculateDistanceByIndex(dayId, newIndex - 1, newIndex);
            calculateDistanceByIndex(dayId, newIndex, newIndex + 1);
            return newIndex;
        }










</script>





</body>
</html>
