<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸ë¼ì¸ ë‚ ì§œ ë²”ìœ„ ì„ íƒê¸°</title>

    <!-- jQuery & Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Moment.js & Date Range Picker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-date-range-picker/dist/daterangepicker.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery-date-range-picker/dist/jquery.daterangepicker.min.js"></script>



    <style>


        .modal-dialog {
            max-width: 750px; /* ëª¨ë‹¬ì´ ë‹¬ë ¥ì„ í¬í•¨í•  ë§Œí¼ ì¶©ë¶„íˆ ë„“ê²Œ ì„¤ì • */
            user-select: none;
        }


        .modal-content {
            height: auto;
            min-height: 100%;
        }

        .date-range-container{ width: 17em; padding: .2em .2em 0; display: none; font-size:62.5%; }

        /* ë‚ ì§œ ì„ íƒê¸° ë˜í¼ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper {
            width:100%; font-size: 11px;
            display: flex; /* ë‚´ë¶€ ìš”ì†Œë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜ */
            /*flex-wrap: nowrap; !* ì¤„ë°”ê¿ˆ ë°©ì§€ *!*/
            /*justify-content: center; !* ìš”ì†Œë¥¼ ì¤‘ì•™ ì •ë ¬ *!*/
            /*align-items: flex-start; !* ìƒë‹¨ ì •ë ¬ *!*/
            /*padding: 16px; !* ë‚´ë¶€ ì—¬ë°± ì„¤ì • *!*/
            background: #ffffff; /* ë°°ê²½ìƒ‰ ì„¤ì • */
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            /*max-width: 100%;*/
        }


        /* ì›” ì´ë¦„ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .month-name {
            padding-top: .2em;
            font-size:120%;
            font-weight: 500;
            color: #000000;
        }

        /* ì›” ë˜í¼ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .month-wrapper {
            display: flex;
            border: none;
            width: 100% !important;
            flex-wrap: wrap;
            justify-content: center;
            /*min-width: 650px;*/
        }


        .date-picker-wrapper .month-wrapper table.month1 {
            border-right: 1px solid rgba(0, 0, 0, 0.10);
        }

        /* ì›” ìº¡ì…˜ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .month-wrapper .caption {
            height: 80px;
        }

        /* ìš”ì¼ëª… ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .month-wrapper table .week-name {
            font-size: 120%;
            font-weight: 100;
            color: #000000;
        }

        /* ë‚ ì§œ ì…€ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .month-wrapper table td {
            text-align: center;
            cursor: pointer;
        }

        .date-picker-wrapper .month-wrapper table .day.real-today {
            background-color: #00ff59;
            border-radius: 30px;
        }

        #date-range-container {
            width : 100%;
            background: #ffffff; /* ë°°ê²½ìƒ‰ ì„¤ì • */
            /*display: inline-block; !* ì¸ë¼ì¸ ë¸”ë¡ ìš”ì†Œë¡œ ì„¤ì • *!*/
        }


        /* ê°œë³„ ë‚ ì§œ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .month-wrapper table .day {
            margin: 2px;
            width: 2.5em;
            height: 2.5em;
            padding-top: 5px;
            padding-bottom: 5px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            line-height: 32px;
        }

        /* ë‹¤ë¥¸ ë‹¬ì˜ ë‚ ì§œ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .day.other-month {
            color: #d1d5db;
        }

        /* ìœ íš¨í•œ ë‚ ì§œì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œì˜ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .day.valid:hover {
            background: #f3f4f6;
            color: #000000;
        }

        /* ì„ íƒëœ ë‚ ì§œ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .day.selected {
            background: #9c9c9c !important;
            color: #ffffff !important;
            font-weight: bold;
        }

        /* ë‚ ì§œì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .day.hovering {
            background: #ededed !important;
            border-radius: 6px; /* 15% â†’ 6px */
        }

        /* ì„ íƒëœ ë‚ ì§œ ë²”ìœ„ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .day.toMonth.valid.checked {
            background: #e6e6e6 !important;
            border-radius: 6px; /* 15% â†’ 6px */
        }

        /* ë²”ìœ„ ì„ íƒ ì‹œ ì²« ë²ˆì§¸ ë‚ ì§œ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .day.toMonth.valid.checked.first-date-selected {
            border-top-left-radius: 6px; /* 15% â†’ 6px */
            border-bottom-left-radius: 6px; /* 15% â†’ 6px */
            background: #000000 !important;
            color: #ffffff !important;
        }

        /* ë²”ìœ„ ì„ íƒ ì‹œ ë§ˆì§€ë§‰ ë‚ ì§œ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper .day.toMonth.valid.checked.last-date-selected {
            border-top-right-radius: 6px; /* 15% â†’ 6px */
            border-bottom-right-radius: 6px; /* 15% â†’ 6px */
            background: #000000 !important;
            color: #ffffff !important;
        }

        /* ìº¡ì…˜(ì›” í‘œê¸° ë¶€ë¶„) ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper table .caption {
            font-size: 16px; /* 1rem â†’ 16px */
        }

        /* ë‹¤ìŒ ë‹¬ ì´ë™ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper table .caption .next:hover {
            color: #000000 !important;
            background: transparent !important;
        }

        /* ì´ì „ ë‹¬ ì´ë™ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .date-picker-wrapper table .caption .prev:hover {
            color: #000000 !important;
            background: transparent !important;
        }

        .drp_top-bar normal{
            display: none;
        }


        #step-container {
            position: relative; /* ìì‹ absolute ìœ„ì¹˜ ê¸°ì¤€ */
            min-height: 527px; /* ê°€ì¥ ë†’ì€ í¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì • */
        }

        /* ë‘ ìš”ì†Œë¥¼ ì™„ì „íˆ ê²¹ì¹˜ë„ë¡ ì„¤ì • */
        #step-date-selection,
        #step-time-selection {
            position: absolute;
            overflow-y: auto;
            overflow-x:hidden;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* ì´ˆê¸° ì„¤ì •: ì²« ë²ˆì§¸ í¼ë§Œ ë³´ì´ê²Œ */
        #step-date-selection {
            visibility: visible;
            opacity: 1;
            z-index: 2;
        }

        #step-time-selection {
            visibility: hidden;
            opacity: 0;
            z-index: 1;
        }

        .time-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-picker-wrapper .gap {
            display: none;
        }
        .date-label { width: 120px; font-weight: bold; text-align: right; margin-right: 10px;}

        .time-input {
            width: 150px;
            margin-right: 10px;
        }



    </style>
</head>
<body>
<div class="modal fade" id="travelModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4">
            <div class="modal-header border-0">
                <h2 class="modal-title text-center w-100 fw-light" id="modal-title">ì—¬í–‰ ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”</h2>
            </div>
            <div class="modal-body text-center" id="modal-body">
                <div id="step-container">
                    <!-- ì—¬í–‰ ê¸°ê°„ ì„ íƒ -->
                    <div id="step-date-selection">
                        <p class="fw-light">ì—¬í–‰ ì¼ìëŠ” ìµœëŒ€ 7ì¼ê¹Œì§€ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                        <div id="date-range-container" class="mb-3"></div>
                        <p><span id="selected-date">ã€€</span></p>
                    </div>

                    <!-- ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ì„¤ì • -->
                    <div id="step-time-selection">
                        <div class="time-container">
                            <span class="date-label">ì „ì²´ ì ìš©</span>
                            <input type="time" id="start-global" class="form-control time-input" value="09:00">
                            <input type="time" id="end-global" class="form-control time-input" value="23:00">
                            <button id="apply-global-time" class="btn btn-secondary" >ì „ì²´ ì ìš©</button>
                        </div>
                        <hr>
                        <div id="time-selection-container"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 d-flex justify-content-between">
                <button id="back-btn" class="btn btn-secondary" style="visibility: hidden;">ë’¤ë¡œ ê°€ê¸°</button>
                <button id="next-btn" class="btn btn-dark">ë‹¤ìŒ</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    const modalTitle = document.getElementById("modal-title");
    const stepDateSelection = document.getElementById("step-date-selection");
    const stepTimeSelection = document.getElementById("step-time-selection");
    const backButton = document.getElementById("back-btn");
    const nextButton = document.getElementById("next-btn");



    nextButton.addEventListener("click", function () {
        if (currentStep === 1) {
            console.log("ğŸ“Œ [ë²„íŠ¼ í´ë¦­] 'ë‹¤ìŒ' ë²„íŠ¼ í´ë¦­ë¨");

            if (selectedDates.length === 0) {
                alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                return;
            } else  if (selectedDates.length > 7) {
                alert("ì—¬í–‰ ì¼ìëŠ” ìµœëŒ€ 7ì¼ê¹Œì§€ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            console.log("âœ… ì„ íƒëœ ë‚ ì§œ:", selectedDates);
            createTimeSelectionUI(selectedDates, selectedDates.length);

            // ì—¬í–‰ ê¸°ê°„ â†’ ì—¬í–‰ ì‹œê°„ìœ¼ë¡œ ë³€ê²½
            stepDateSelection.style.opacity = "0";
            stepDateSelection.style.zIndex = "1";
            stepDateSelection.style.visibility = "hidden";


            stepTimeSelection.style.zIndex = "2";
            stepTimeSelection.style.visibility = "visible";
            stepTimeSelection.style.opacity = "1";


            changeTitle("ì‹œì‘ ë° ì¢…ë£Œ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”");
            backButton.style.visibility = "visible";
            currentStep = 2;
        } else {
            dateSubmit();
            console.log("âœ… ì—¬í–‰ ì‹œê°„ ì„¤ì • ì™„ë£Œ");
            travelModal.hide();
        }
    });

    backButton.addEventListener("click", function () {
        if (currentStep === 2) {
            stepTimeSelection.style.opacity = "0";
            stepTimeSelection.style.zIndex = "1";
            stepTimeSelection.style.visibility = "hidden";


            stepDateSelection.style.zIndex = "2";
            stepDateSelection.style.visibility = "visible";
            stepDateSelection.style.opacity = "1";


            changeTitle("ì—¬í–‰ ê¸°ê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”");
            backButton.style.visibility = "hidden";
            currentStep = 1;
        }
    });

    function changeTitle(newText) {
        modalTitle.textContent = newText;
    }



    // ì „ì—­ë³€ìˆ˜ ì„ ì–¸ (í˜¸ì´ìŠ¤íŒ…)
    let travelModal;
    let timeModal;
    let selectedDates = [];

    function createTimeSelectionUI(selectedDates, dayCounts) {
        console.log("ğŸ“Œ [ì‹œê°„ UI ìƒì„±] ì„ íƒëœ ë‚ ì§œë“¤:", selectedDates);

        // 1ë¶€í„° dayCountsê¹Œì§€ì˜ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        let dayList = Array.from({ length: dayCounts }, (_, i) => i + 1);

        let timeSelectionHTML = "";
        dayList.forEach(index => {
            timeSelectionHTML += `
                <div class="time-container mb-3">
                    <span class="date-label">${index}ì¼ì°¨</span>
                    <input type="time" class="form-control time-input" id="start-${index}" value="09:00">
                    <input type="time" class="form-control time-input" id="end-${index}" value="23:00">
                    <button id="apply-global-time" class="btn btn-secondary" style="visibility: hidden;">ì „ì²´ ì ìš©</button>
                </div>
            `;
        });

        $('#time-selection-container').html(timeSelectionHTML);

    }


    $(document).ready(function () {
        console.log("ğŸ“… ìº˜ë¦°ë” ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨");

        travelModal = new bootstrap.Modal(document.getElementById("travelModal"));
        const timeModalElement = document.getElementById("timeModal"); // âœ… HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        travelModal.show();


        //===============================
        //  ğŸ“… ìº˜ë¦°ë” ìŠ¤í¬ë¦½íŠ¸
        //================================
        $('#date-range-container').dateRangePicker({
            parentEl: "modal-body",
            inline: true,
            container: '#date-range-container',
            alwaysOpen: true,
            stickyMonths: true,
            language: 'ko',
            format: 'YYYY-MM-DD',
            separator: ' ~ ',
            startOfWeek: 'sunday',
            showShortcuts: false,
            customTopBar: ' ',
            hoveringTooltip: false,
            autoClose: true
        }).bind('datepicker-change', function (event, obj) {
            let tempSelectedDates = [];
            let start = moment(obj.date1);
            let end = moment(obj.date2);

            while (start <= end) {
                tempSelectedDates.push(start.format('YYYY-MM-DD'));
                start.add(1, 'days');
            }

            selectedDates = tempSelectedDates;
            console.log("âœ… ì„ íƒëœ ë‚ ì§œ:", selectedDates);

            $('#selected-date')
                .text(obj.value)
                .css({ opacity: 0 })
                .animate({ opacity: 1 }, 300);
        });

        let initialStart = '2025-03-03';
        let initialEnd = '2025-03-07';

        let tempSelectedDates = [];
        let start = moment(initialStart);
        let end = moment(initialEnd);

        while (start <= end) {
            tempSelectedDates.push(start.format('YYYY-MM-DD'));
            start.add(1, 'days');
        }

        selectedDates = tempSelectedDates;
        console.log("âœ… ì„ íƒëœ ë‚ ì§œ:", selectedDates);
        $("#date-range-container").data('dateRangePicker').setDateRange(initialStart,initialEnd);
    });


    //===============================
    //  ğŸ“… ì‹œê°„ì„¤ì • ìŠ¤í¬ë¦½íŠ¸
    //================================
    $(document).ready(function () {
        console.log("â° ì‹œê°„ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨");

        $('#apply-global-time').click(function () {
            let globalStart = $('#start-global').val();
            let globalEnd = $('#end-global').val();
            console.log("ğŸ“Œ [ì „ì²´ ì ìš©] ì‹œì‘ì‹œê°„:", globalStart, "ì¢…ë£Œì‹œê°„:", globalEnd);
            // 1ë¶€í„° dayCountsê¹Œì§€ì˜ ë¦¬ìŠ¤íŠ¸ ìƒì„±
            let dayList = Array.from({ length: selectedDates.length }, (_, i) => i + 1);
            dayList.forEach(index => {
                $(`#start-${index}`).val(globalStart);
                $(`#end-${index}`).val(globalEnd);
            });
        });


    });

    function dateSubmit() {
        console.log("ğŸ“Œ [ì™„ë£Œ ë²„íŠ¼ í´ë¦­]");
        const itineraryJSON = generateItineraryJSON();

        if (!itineraryJSON) {
            alert("ì—¬í–‰ ì¼ì •ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ì¤‘ë³µ í´ë¦­ ë°©ì§€ (ë²„íŠ¼ ë¹„í™œì„±í™”)
        $('#confirm-time-btn').prop('disabled', true).text("ì €ì¥ ì¤‘...");

        // Ajax ìš”ì²­
        $.ajax({
            url: "/api/itinerary/create",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(itineraryJSON),
            beforeSend: function () {
                // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ í‘œì‹œ (ì¶”ê°€ ê°€ëŠ¥)
                $('#loading-spinner').show();
            },
            success: function (response) {
                console.log("âœ… ì¼ì • ì €ì¥ ì„±ê³µ:", response);
                alert("ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                timeModal.hide();
            },
            error: function (xhr, status, error) {
                console.error("âŒ ì¼ì • ì €ì¥ ì‹¤íŒ¨:", error);
                alert("ì¼ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            },
            complete: function () {
                // ìš”ì²­ ì™„ë£Œ í›„ ë²„íŠ¼ í™œì„±í™” ë° ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìˆ¨ê¸°ê¸°
                $('#confirm-time-btn').prop('disabled', false).text("ì™„ë£Œ");
                $('#loading-spinner').hide();
            }
        });
    }
    function generateItineraryJSON() {
        // 1. ì„ íƒëœ ë‚ ì§œê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
        if (!selectedDates || selectedDates.length === 0) {
            alert("ì—¬í–‰ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");  // ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
            return null;
        }

        // 2. itineraryDTO ê°ì²´ ìƒì„±
        const startDateStr = moment(selectedDates[0]).format("YYYY-MM-DD") + "T00:00:00";
        const itinerary = {
            itineraryName: "ì„œìš¸ ì—¬í–‰",           // ì—¬í–‰ ì´ë¦„ (ê¸°ë³¸ê°’ ë˜ëŠ” ì‚¬ìš©ì ì…ë ¥ê°’)
            startDate: startDateStr,              // ì²« ë²ˆì§¸ ì—¬í–‰ ë‚ ì§œ (ì‹œê° 00:00:00 ê³ ì •)
            totalDays: selectedDates.length,      // ì „ì²´ ì—¬í–‰ ì¼ìˆ˜
            transportationType: 1                 // êµí†µ ìˆ˜ë‹¨ ìœ í˜• (ì˜ˆ: 1, ê¸°ë³¸ê°’)
        };

        // 3. ItineraryPerDays ë°°ì—´ ìƒì„±
        const ItineraryPerDays = selectedDates.map((date, index) => {
            const dayMoment = moment(date);
            return {
                dayCount: index + 1,                // 1ì¼ë¶€í„° ì‹œì‘í•˜ëŠ” ì¼ì°¨ ë²ˆí˜¸
                startTime: $(`#start-${index+1}`).val() + ":00",
                endTime: $(`#end-${index+1}`).val() + ":00",
                dayOfWeek: dayMoment.isoWeekday()   // ìš”ì¼ ë²ˆí˜¸ (ì›”=1, ... , ì¼=7)
            };
        });

        // 4. ìµœì¢… JSON ë°ì´í„° êµ¬ì„±
        const itineraryJSON = {
            itinerary: itinerary,
            itineraryPerDays: ItineraryPerDays
        };

        // JSON ê²°ê³¼ë¥¼ ì½˜ì†”ì— ì¶œë ¥ (ê°€ë…ì„±ì„ ìœ„í•´ ë“¤ì—¬ì“°ê¸° í¬í•¨)
        console.log(JSON.stringify(itineraryJSON, null, 2));

        // JSON ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì—¬ ë‹¤ë¥¸ ê³³ì—ì„œ í™œìš© ê°€ëŠ¥í•˜ë„ë¡ í•¨
        return itineraryJSON;
    }
</script>





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
