<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Google Maps ì¥ì†Œ ê²€ìƒ‰</title>
    <script>
        let map;
        let markers = [];
        let debounceTimer;

        // function requestPostGoogleMap() {
        //     fetch('/api/place/search', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify({
        //             userId: '1234',
        //             googlePlaceId: 'PLACE_ID',
        //             placeName: 'ë©”ì´ë“œ ìœ ì˜ì›'
        //         })
        //     })
        //         .then(response => response.json())
        //         .then(data => console.log('ì‘ë‹µ ë°ì´í„°:', data))
        //         .catch(error => console.error('ì—ëŸ¬ ë°œìƒ:', error));
        // }


        function loadGoogleMapsApi() {
            fetch('/api/place/apikey')
                .then(response => response.text())
                .then(apiKey => {
                    let script = document.createElement("script");
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                })
                .catch(error => console.error("API Key ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error));
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.5665, lng: 126.9780 },
                zoom: 13
            });
        }

        function searchPlaces() {
            let input = document.getElementById("searchInput").value.trim();

            if (input.length < 2) {
                document.getElementById("results").innerHTML = "";
                return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetch(`/api/place/autocomplete?input=${encodeURIComponent(input)}`)
                    .then(response => response.json())
                    .then(data => {
                        let results = data.predictions;
                        let list = document.getElementById("results");
                        list.innerHTML = "";

                        if (results.length === 0) {
                            list.innerHTML = "<li>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
                            return;
                        }

                        results.forEach((place, index) => {
                            let li = document.createElement("li");
                            li.textContent = place.description;
                            li.onclick = () => selectPlace(place.place_id, place.description);
                            list.appendChild(li);
                        });
                    })
                    .catch(error => console.error("Error:", error));
            }, 300);
        }

        function selectPlace(placeId, placeName) {
            fetch(`/api/place/place-details`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ placeId: placeId, mainText: placeName })
            })
                .then(response => response.json())
                .then(data => {
                    console.log("ğŸ“Œ API ì‘ë‹µ ë°ì´í„°:", data);

                    if (!data.lat || !data.lng) {
                        console.error("ì˜ëª»ëœ ì¥ì†Œ ë°ì´í„°:", data);
                        return;
                    }

                    let location = { lat: data.lat, lng: data.lng };
                    console.log("ğŸ“ ì§€ë„ ì´ë™:", location);

                    // âœ… ì§€ë„ ì¤‘ì‹¬ ì´ë™ ë° ë§ˆì»¤ ì¶”ê°€
                    map.setCenter(location);
                    map.setZoom(15);
                    markers.forEach(marker => marker.setMap(null));
                    markers = [];
                    let marker = new google.maps.Marker({ position: location, map: map });
                    markers.push(marker);

                    // âœ… ì¥ì†Œ ìƒì„¸ ì •ë³´ UI ì—…ë°ì´íŠ¸
                    updatePlaceDetails(data);
                })
                .catch(error => console.error("Error:", error));
        }

        function updatePlaceDetails(data) {
            document.getElementById("placeName").innerText = data.place_name;
            document.getElementById("placeAddress").innerText = data.formatted_address;
            document.getElementById("placeRating").innerText = data.rating;
            document.getElementById("placeReviewCount").innerText = data.review_count;
            document.getElementById("placeHours").innerText = data.opening_hours ? data.opening_hours.join(", ") : "ì •ë³´ ì—†ìŒ";
            document.getElementById("placeDescription").innerText = data.description || "ì„¤ëª… ì—†ìŒ";

            if (data.photos && data.photos.length > 0) {
                document.getElementById("placeImage").src = data.photos[0];
            } else {
                document.getElementById("placeImage").src = "https://via.placeholder.com/400x300?text=No+Image";
            }

            document.getElementById("placeDetails").style.display = "block";
        }




        document.getElementById("searchInput").addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                let resultsList = document.getElementById("results").getElementsByTagName("li");

                if (resultsList.length > 0) {
                    resultsList[0].click();
                }
            }
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 500px;
            margin-top: 10px;
        }
        #searchContainer {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        #searchInput {
            width: 300px;
            padding: 8px;
            font-size: 16px;
        }
        #results {
            list-style: none;
            padding: 0;
            max-width: 320px;
            background: white;
            border: 1px solid #ccc;
            position: absolute;
            z-index: 10;
        }
        #results li {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        #results li:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body onload="loadGoogleMapsApi()">
<div id="searchContainer">
    <input id="searchInput" type="text" placeholder="ì¥ì†Œ ê²€ìƒ‰" oninput="searchPlaces()">
    <button onclick="searchPlaces()">ê²€ìƒ‰</button>
</div>
<!-- ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
<ul id="results"></ul>

<!-- ì§€ë„ í‘œì‹œ -->
<div id="map"></div>

<!-- âœ… ì¥ì†Œ ìƒì„¸ ì •ë³´ ì˜ì—­ -->
<div id="placeDetails" style="display: none;">
    <h2 id="placeName"></h2>
    <img id="placeImage" src="" alt="ì¥ì†Œ ì´ë¯¸ì§€" style="width: 100%; max-height: 300px;">
    <p><strong>ì£¼ì†Œ:</strong> <span id="placeAddress"></span></p>
    <p><strong>í‰ì :</strong> <span id="placeRating"></span> â­ï¸ (<span id="placeReviewCount"></span> ë¦¬ë·°)</p>
    <p><strong>ì˜ì—…ì‹œê°„:</strong> <span id="placeHours"></span></p>
    <p><strong>ì„¤ëª…:</strong> <span id="placeDescription"></span></p>
</div>

</body>
</html>
